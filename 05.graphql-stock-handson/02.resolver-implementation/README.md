# 2. Resolver ã®è²¬å‹™ã¨åˆ†é›¢ï¼ˆGraphQL å®Ÿè£…ç·¨ï¼‰

å‰ç« ã§è¨­è¨ˆã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ã€**NestJS + Codeâ€‘First** ã§å®Ÿè£…ã—ã¾ã™ã€‚
GraphQL ã§ã¯ã€ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã¨åŒã˜ãã‚‰ã„ **Resolver ã®è²¬å‹™åˆ†é›¢** ãŒé‡è¦ã§ã™ã€‚
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»æ‹¡å¼µæ€§ãƒ»å¯èª­æ€§ã‚’å¤§ããå·¦å³ã—ã¾ã™ã€‚

---

## ğŸ¯ æœ¬ç« ã®ã‚´ãƒ¼ãƒ«

- Query Resolver ã¨ Field Resolver ã®é•ã„ã‚’ç†è§£ã™ã‚‹
- ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã‚’ã©ã“ã«æ›¸ãã¹ãã‹ã€å½¹å‰²åˆ†æ‹…ã®è€ƒãˆæ–¹ã‚’å­¦ã¶
- Resolver å®Ÿè£…æ™‚ã«é™¥ã‚Šã‚„ã™ã„ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãã®å›é¿æ³•ã‚’çŸ¥ã‚‹

---

## ğŸ“˜ å­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—

### Step&nbsp;1. Query Resolver / Field Resolver ã®åŸºæœ¬

| ç¨®é¡               | å½¹å‰²                                             | ä¾‹                             |
| ------------------ | ------------------------------------------------ | ------------------------------ |
| **Query Resolver** | æœ€ä¸Šä½ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã®èµ·ç‚¹ã«ãªã‚‹ | `stocks(clientId: ID!)`        |
| **Field Resolver** | Object ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å€‹åˆ¥ã«è§£æ±ºã™ã‚‹            | `Stock.client`, `Stock.photos` |

---

### Step&nbsp;2. Stock / Client / Photo ã‚’ Resolver ã§åˆ†é›¢å®Ÿè£…

| Resolver   | è²¬å‹™                                  | å®Ÿè£…å¯¾è±¡         |
| ---------- | ------------------------------------- | ---------------- |
| **stocks** | `clientId` ã§çµã‚Šè¾¼ã‚“ã åœ¨åº«ä¸€è¦§ã‚’è¿”ã™ | `Query.stocks()` |
| **client** | `stock.clientId` â†’ Client è©³ç´°ã‚’è¿”ã™  | `Stock.client()` |
| **photos** | `stock.id` â†’ Photo ä¸€è¦§ã‚’è¿”ã™         | `Stock.photos()` |

> ã•ã‚‰ã«è‡¨å ´æ„Ÿã‚’å‡ºã™ãŸã‚ã€æ¬¡ã® **è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰** ã‚‚ Field Resolver ã§å®Ÿè£…ã—ã¾ã™ã€‚
>
> - `Stock.priceWithTax`ï¼ˆç¨è¾¼è¨ˆç®—ï¼‰
> - `Client.displayName`ï¼ˆéƒ½é“åºœçœŒä»˜ãåç§°ï¼‰
> - `Photo.thumbnailUrl`ï¼ˆCDN ã‚µãƒ ãƒã‚¤ãƒ« URL ç”Ÿæˆï¼‰

---

### Step&nbsp;3. å®Ÿè£…æ¼”ç¿’

ä»¥ä¸‹ã® Resolver ãƒ•ã‚¡ã‚¤ãƒ«ã® **`TODO:`** ã‚’åŸ‹ã‚ã¦ã€ãã‚Œãã‚Œã®ãƒ‡ãƒ¼ã‚¿å–å¾—è²¬å‹™ã‚’ä½“é¨“ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

| ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹                       | å¯¾è±¡ Resolver                                         | å†…å®¹                                      |
| ---------------------------------- | ----------------------------------------------------- | ----------------------------------------- |
| `demo-skeleton/stock.resolver.ts`  | `Query.stocks`, `Stock.client`, `Stock.photos`        | åœ¨åº«ã«é–¢ã™ã‚‹åŸºæœ¬ã®ãƒã‚¹ãƒˆè§£æ±ºã‚’å®Ÿè£…        |
| `demo-skeleton/client.resolver.ts` | `Query.client`, `Query.clients`, `Client.displayName` | è²©å£²åº—æƒ…å ±ã®å–å¾—ã¨è¡¨è¨˜åŠ å·¥ã‚’å®Ÿè£…          |
| `demo-skeleton/photo.resolver.ts`  | `Query.photosByStock`, `Photo.thumbnailUrl`           | å†™çœŸä¸€è¦§ã®å–å¾—ã¨ã‚µãƒ ãƒã‚¤ãƒ« URL ç”Ÿæˆã‚’å®Ÿè£… |

---

#### âœ… å®Ÿè£…æ‰‹é †

1. å„ `demo-skeleton/*.resolver.ts` ã® `TODO:` ã‚’åŸ‹ã‚ã¦å®Ÿè£…
2. `pnpm run start` ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€GraphQL ã‚¯ã‚¨ãƒªãŒæ­£ã—ãè¿”ã‚‹ã‹ç¢ºèª
3. `demo-answer/*.resolver.ts` ã‚’è¦‹ã¦è‡ªåˆ†ã®å®Ÿè£…ã¨æ¯”è¼ƒã—ã€
   - `Query` ã¨ `Field` ã®ä½¿ã„åˆ†ã‘
   - ãƒ­ã‚¸ãƒƒã‚¯ã®ç½®ãæ‰€ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‹ Resolver ã‹ï¼‰
   - ãƒã‚¹ãƒˆæ§‹é€ ã®è§£æ±ºæ–¹æ³•
     ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã—ã‚‡ã†

---

## âš ï¸ ã‚ˆãã‚ã‚‹ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

### âŒ Field Resolver ã§å€‹åˆ¥ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹

```ts
@ResolveField(() => Client)
client(@Parent() stock: Stock) {
  // ä¸€è¦§ 10 ä»¶ã§ 10 å›å‘¼ã°ã‚Œã‚‹ â†’ N+1 å•é¡Œ
  return this.clientService.fetchClientById(stock.clientId);
}
```

- N+1 å•é¡Œã®å…¸å‹ä¾‹
- ä¸€è¦§è¡¨ç¤ºã§ã¯è‡´å‘½çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹
- æ¬¡ç«  ã§ DataLoader ã«ã‚ˆã‚‹ãƒãƒƒãƒåŒ–ã‚’å­¦ã³ã¾ã™

---

## ğŸš€ èµ·å‹•æ‰‹é †ï¼ˆãŠã•ã‚‰ã„ï¼‰

```bash
# ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ã‚¢ãƒ—ãƒªèµ·å‹•
pnpm run start
# => http://localhost:3000/graphql ãŒç«‹ã¡ä¸ŠãŒã‚‹
```

---

## ğŸ” å‹•ä½œç¢ºèªã‚¯ã‚¨ãƒªä¾‹

```graphql
query {
  stocks {
    id
    name
    modelYear
    price # ç¨æŠœ
    priceWithTax # è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šç¨è¾¼
    mileage
    clientId
    client {
      id
      displayName # è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šéƒ½é“åºœçœŒä»˜ãåç§°
    }
    photos {
      id
      url
      isMain
      thumbnailUrl
    }
  }
}
```

---

## âœ… æ¬¡ã«é€²ã‚€

æ¬¡ç« ã§ã¯ã€ä»Šå›ç™ºç”Ÿã—ãŸ N+1 å•é¡Œ ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€
DataLoader ã®å°å…¥ã¨ãƒãƒƒãƒå‡¦ç† ã‚’å­¦ã³ã¾ã™ã€‚

ğŸ‘‰ 3. N+1 å•é¡Œã¨ DataLoader ã§ã®è§£æ±ºã¸é€²ã‚€
