# 2. Resolver ã®è²¬å‹™ã¨åˆ†é›¢ï¼ˆGraphQL å®Ÿè£…ç·¨ï¼‰

å‰ç« ã§è¨­è¨ˆã—ãŸã‚¹ã‚­ãƒ¼ãƒã‚’ã€**NestJS + Codeâ€‘First** ã§å®Ÿè£…ã—ã¾ã™ã€‚
GraphQL ã§ã¯ã€ã‚¹ã‚­ãƒ¼ãƒè¨­è¨ˆã¨åŒã˜ãã‚‰ã„ **Resolver ã®è²¬å‹™åˆ†é›¢** ãŒé‡è¦ã§ã™ã€‚
ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»æ‹¡å¼µæ€§ãƒ»å¯èª­æ€§ã‚’å¤§ããå·¦å³ã—ã¾ã™ã€‚

---

## ğŸ¯ æœ¬ç« ã®ã‚´ãƒ¼ãƒ«

- Query Resolver ã¨ Field Resolver ã®é•ã„ã‚’ç†è§£ã™ã‚‹
- ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã‚’ã©ã“ã«æ›¸ãã¹ãã‹ã€å½¹å‰²åˆ†æ‹…ã®è€ƒãˆæ–¹ã‚’å­¦ã¶
- Resolver å®Ÿè£…æ™‚ã«é™¥ã‚Šã‚„ã™ã„ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãã®å›é¿æ³•ã‚’çŸ¥ã‚‹

---

## Step 0. ğŸ§© Resolver ã®è²¬å‹™ï¼ˆæŠ½è±¡åŒ–ã•ã‚ŒãŸè¨­è¨ˆåŸå‰‡ï¼‰

### Query Resolverï¼ˆèµ·ç‚¹ï¼‰

| å†…å®¹      | èª¬æ˜                                                                    |
| --------- | ----------------------------------------------------------------------- |
| âœ… è²¬å‹™   | ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã€æ¡ä»¶ä»˜ã/æ¡ä»¶ãªã—ã®ãƒ‡ãƒ¼ã‚¿é›†åˆã‚’è¿”ã™ |
| âœ… å¯¾è±¡   | ä¸€è¦§ç³»ãƒ»è©³ç´°ç³»ã®æœ€ä¸Šä½ã‚¯ã‚¨ãƒªï¼ˆä¾‹: `stocks`, `client(id)`ï¼‰              |
| âœ… å‡¦ç†ä¾‹ | DB/API ã‚¢ã‚¯ã‚»ã‚¹ã€æ¤œç´¢æ¡ä»¶ã®æŠ½è±¡åŒ–ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãƒ»ã‚½ãƒ¼ãƒˆãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼       |

---

### Field Resolverï¼ˆæ§‹é€ ã¨å†æ§‹æˆï¼‰

| å†…å®¹      | èª¬æ˜                                                                           |
| --------- | ------------------------------------------------------------------------------ |
| âœ… è²¬å‹™   | è¦ªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® context ã«åŸºã¥ãã€é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è§£æ±ºã™ã‚‹                    |
| âœ… å¯¾è±¡   | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ1 å¯¾ 1, 1 å¯¾å¤šï¼‰ã€æ´¾ç”Ÿå€¤ã€æ­£è¦åŒ–æ§‹é€ ã®å†æ§‹æˆãªã©                 |
| âœ… å‡¦ç†ä¾‹ | `stock.client` ã‚„ `purchaseInfo.supplier`ã€`priceWithTax` ã®ã‚ˆã†ãªåŠ å·¥å€¤ã®ç®—å‡º |

---

### Modelï¼ˆObjectTypeï¼‰

| å†…å®¹    | èª¬æ˜                                                 |
| ------- | ---------------------------------------------------- |
| âœ… è²¬å‹™ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨å…±æœ‰ã™ã‚‹æ§‹é€ ï¼ˆèªå½™ï¼‰ã®å®šç¾©           |
| âœ… å¯¾è±¡ | ãƒ‰ãƒ¡ã‚¤ãƒ³èªå½™ã‚’ GraphQL ã‚¹ã‚­ãƒ¼ãƒã¨ã—ã¦æ˜æ–‡åŒ–ã—ãŸã‚‚ã®  |
| âœ… ç‰¹å¾´ | å†åˆ©ç”¨ãƒ»ãƒã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ãƒ»ãƒ†ã‚¹ãƒˆæ€§ã®å‘ä¸Šã«å¯„ä¸ |

---

### Serviceï¼ˆå–å¾—ã¨å¤‰æ›ã®è²¬ä»»ï¼‰

| å†…å®¹    | èª¬æ˜                                                          |
| ------- | ------------------------------------------------------------- |
| âœ… è²¬å‹™ | Resolver ã‹ã‚‰åˆ†é›¢ã•ã‚ŒãŸã€Œå–å¾—ãƒ»å¤‰æ›ãƒ»åŠ å·¥ã€å‡¦ç†ã‚’æ‹…ã†         |
| âœ… å¯¾è±¡ | ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ID æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»å¤‰æ›ãƒ»ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«åˆ¤å®šãªã© |
| âœ… ç‰¹å¾´ | Resolver ã‚’è–„ãä¿ã¡ã€å†åˆ©ç”¨æ€§ã¨ãƒ†ã‚¹ãƒˆæ€§ã‚’é«˜ã‚ã‚‹               |

---

### å…¨ä½“æ§‹é€ ã¨ã—ã¦ã®å®šç¾©

| åŒºåˆ†             | å½¹å‰²                               |
| ---------------- | ---------------------------------- |
| `Query`          | ãƒ•ãƒ­ãƒ³ãƒˆã®èµ·ç‚¹ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã®é›†ç´„å˜ä½ |
| `Field Resolver` | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„æ´¾ç”Ÿå€¤ã®è§£æ±ºã‚’åˆ†é›¢   |
| `Model`          | ãƒ‰ãƒ¡ã‚¤ãƒ³èªå½™ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ å®šç¾©       |
| `Service`        | å–å¾—ãƒ»å¤‰æ›ãƒ»ãƒ­ã‚¸ãƒƒã‚¯å‡¦ç†ã®å®Ÿä½“     |

> ğŸ“Œ GraphQL ã«ãŠã‘ã‚‹ Resolver ã®è²¬å‹™ã¨ã¯ã€
> **ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã®èªå½™ã¨æ§‹é€ ã‚’ã€æœ€å°è²¬ä»»å˜ä½ã§åˆ†è§£ã—ã€å¿…è¦ãªç®‡æ‰€ã§å†æ§‹æˆã™ã‚‹ã“ã¨ã€**

---

## ğŸ“˜ å­¦ç¿’ã‚¹ãƒ†ãƒƒãƒ—

### Step&nbsp;1. Query Resolver / Field Resolver ã®åŸºæœ¬

GraphQL ã«ãŠã‘ã‚‹ Resolver ã¯ã€å¤§ãã **Query Resolver**ï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã®èµ·ç‚¹ï¼‰ã¨
**Field Resolver**ï¼ˆæ§‹é€ ã‚’å±•é–‹ãƒ»è§£æ±ºã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å˜ä½ã®è²¬å‹™ï¼‰ã«åˆ†ã‹ã‚Œã¾ã™ã€‚

> ã“ã® 2 ã¤ã®è²¬å‹™ã®é•ã„ã‚’æ˜ç¢ºã«ç†è§£ã—ã¦ãŠãã“ã¨ãŒã€
> ä»Šå¾Œã®ã‚¹ã‚­ãƒ¼ãƒå®Ÿè£…ãƒ»è²¬å‹™åˆ†é›¢ãƒ»æœ€é©åŒ–ï¼ˆN+1 è§£æ¶ˆãªã©ï¼‰ã™ã¹ã¦ã®åŸºç›¤ã«ãªã‚Šã¾ã™ã€‚

ã¾ãšã¯ã“ã®é•ã„ã‚’æ•´ç†ã—ã€ä»¥é™ã®æ¼”ç¿’ã‚„å®Ÿè£…ã®å‰æã¨ã—ã¾ã—ã‚‡ã†ã€‚

| ç¨®é¡               | å½¹å‰²                                             | ä¾‹                             |
| ------------------ | ------------------------------------------------ | ------------------------------ |
| **Query Resolver** | æœ€ä¸Šä½ã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã§ãƒ‡ãƒ¼ã‚¿å–å¾—ã®èµ·ç‚¹ã«ãªã‚‹ | `stocks(clientId: ID!)`        |
| **Field Resolver** | Object ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å€‹åˆ¥ã«è§£æ±ºã™ã‚‹            | `Stock.client`, `Stock.photos` |

---

### Step&nbsp;2. Stock / Client / Photo ã‚’ Resolver ã§åˆ†é›¢å®Ÿè£…

GraphQL ã«ãŠã„ã¦ã¯ã€ã€Œè¦ªã¨ãªã‚‹å‹ï¼ˆã“ã®å ´åˆã¯ Stockï¼‰ã€ã¨ã€Œé–¢é€£å‹ï¼ˆClient, Photoï¼‰ã€ã® **é–¢ä¿‚æ€§ã¨è²¬å‹™ã®åˆ†é›¢** ã‚’æ˜ç¢ºã«è¨­è¨ˆãƒ»å®Ÿè£…ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã¾ãšã¯ `Stock` ã‚’ä¸­å¿ƒã«ã€é–¢é€£ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼ˆClient, Photoï¼‰ã‚’ã©ã®ã‚ˆã†ã«åˆ†é›¢ãƒ»è§£æ±ºã™ã‚‹ã‹ã‚’æ•´ç†ã—ã¾ã™ã€‚

| Resolver   | ç¨®é¡           | è²¬å‹™                                  | å®Ÿè£…å¯¾è±¡         |
| ---------- | -------------- | ------------------------------------- | ---------------- |
| **stocks** | Query Resolver | `clientId` ã§çµã‚Šè¾¼ã‚“ã åœ¨åº«ä¸€è¦§ã‚’è¿”ã™ | `Query.stocks()` |
| **client** | Field Resolver | `stock.clientId` â†’ Client è©³ç´°ã‚’è¿”ã™  | `Stock.client()` |
| **photos** | Field Resolver | `stock.id` â†’ Photo ä¸€è¦§ã‚’è¿”ã™         | `Stock.photos()` |

> `stocks` ã¯æœ€ä¸Šä½ã® Query Resolver ã§ã™ã€‚
> `client` ã¨ `photos` ã¯ Stock å‹ã®å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å€‹åˆ¥ã«è§£æ±ºã™ã‚‹ Field Resolver ã¨ã—ã¦å®Ÿè£…ã—ã¾ã™ã€‚

---

### Step&nbsp;3. é–¢é€£å‹ï¼ˆClient, Photoï¼‰å´ã® Resolver å®Ÿè£…ã«é€²ã‚€

æ¬¡ã«ã€Stock ã«ç´ã¥ãæ§‹é€ ã¨ã¯åˆ¥ã«ã€**Client ã‚„ Photo å˜ä½“ã§ã®å–å¾—ã‚„è¡¨ç¤ºã®åŠ å·¥å‡¦ç†**ã«ã¤ã„ã¦ã‚‚ Resolver ã‚’è¨­è¨ˆãƒ»å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€ã€Œè¤‡æ•°ã® GraphQL å‹ãŒé€£æºã—ãªãŒã‚‰ã‚‚è²¬å‹™ã‚’åˆ†é›¢ã—ã¦å®Ÿè£…ã•ã‚Œã‚‹ã€æ§‹é€ ã‚’å®Ÿä½“é¨“ã§ãã¾ã™ã€‚

> ä¾‹ãˆã°ã€`Client.displayName` ã®ã‚ˆã†ãªè¡¨ç¤ºååŠ å·¥ã¯ `Stock` ã§ã¯ãªã `ClientResolver` å´ã§å®šç¾©ã™ã¹ãã§ã™ã€‚

**æ¼”ç¿’ã§ã¯æ¬¡ã®ã‚ˆã†ãªè¿½åŠ  Field Resolver ã‚‚å¯¾è±¡ã¨ã—ã¾ã™ï¼š**

- `Stock.priceWithTax`ï¼ˆç¨è¾¼ä¾¡æ ¼è¨ˆç®—ï¼‰
- `Client.displayName`ï¼ˆéƒ½é“åºœçœŒä»˜ãã®è²©å£²åº—åï¼‰
- `Photo.thumbnailUrl`ï¼ˆç”»åƒ URL ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜åŠ ã—ã¦ CDN è¡¨ç¤ºï¼‰

---

ã“ã®æµã‚Œã«ã‚ˆã‚Šã€**ã€Œä¸­å¿ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆStockï¼‰ã‚’èµ·ç‚¹ã«ã€é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚„æ´¾ç”Ÿå€¤ã‚’ã©ã®ã‚ˆã†ã«åˆ‡ã‚Šåˆ†ã‘ã‚‹ã‹ã€**
ã¨ã„ã† GraphQL å®Ÿè£…ã«ãŠã‘ã‚‹é‡è¦ãªè¨­è¨ˆæ„Ÿè¦šã‚’èº«ã«ã¤ã‘ã¦ã‚‚ã‚‰ã†ã“ã¨ãŒç‹™ã„ã§ã™ã€‚

---

#### âœ… å®Ÿè£…æ‰‹é †

1. å„ `demo-skeleton/*.resolver.ts` ã® `TODO:` ã‚’åŸ‹ã‚ã¦å®Ÿè£…
2. `pnpm run start` ã§ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã€GraphQL ã‚¯ã‚¨ãƒªãŒæ­£ã—ãè¿”ã‚‹ã‹ç¢ºèª
3. `demo-answer/*.resolver.ts` ã‚’è¦‹ã¦è‡ªåˆ†ã®å®Ÿè£…ã¨æ¯”è¼ƒã—ã€
   - `Query` ã¨ `Field` ã®ä½¿ã„åˆ†ã‘
   - ãƒ­ã‚¸ãƒƒã‚¯ã®ç½®ãæ‰€ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã‹ Resolver ã‹ï¼‰
   - ãƒã‚¹ãƒˆæ§‹é€ ã®è§£æ±ºæ–¹æ³•
     ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã—ã‚‡ã†

---

## ğŸš€ èµ·å‹•æ‰‹é †ï¼ˆãŠã•ã‚‰ã„ï¼‰

```bash
# ä¾å­˜ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm install

# ã‚¢ãƒ—ãƒªèµ·å‹•
pnpm run start
# => http://localhost:3000/graphql ãŒç«‹ã¡ä¸ŠãŒã‚‹
```

---

## ğŸ” å‹•ä½œç¢ºèªã‚¯ã‚¨ãƒªä¾‹

```graphql
query {
  stocks {
    id
    name
    modelYear
    price # ç¨æŠœ
    priceWithTax # è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šç¨è¾¼
    mileage
    clientId
    client {
      id
      displayName # è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šéƒ½é“åºœçœŒä»˜ãåç§°
    }
    photos {
      id
      url
      isMain
      thumbnailUrl
    }
  }
}
```

---

## âœï¸ ç™ºå±•èª²é¡Œï¼šæ­£è¦åŒ–ã•ã‚ŒãŸä»•å…¥æƒ…å ±ãƒ»ä»•å…¥å…ˆã‚’è¿½åŠ å®Ÿè£…ã›ã‚ˆ

åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆStockï¼‰ã«ã¯ã€**ä»•å…¥æƒ…å ±ï¼ˆPurchaseInfoï¼‰ã¨ä»•å…¥å…ˆï¼ˆSupplierï¼‰** ã‚‚ç´ã¥ã„ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã‚’æ­£è¦åŒ–ã•ã‚ŒãŸå½¢ã§ã€GraphQL ã®ã‚¹ã‚­ãƒ¼ãƒãƒ»Resolver ã«çµ±åˆã—ã¦ãã ã•ã„ã€‚

---

### ğŸ¯ ã‚„ã‚‹ã“ã¨

ä»¥ä¸‹ã® 2 ã¤ã® Entity ã«å¯¾ã—ã¦ã€å¿…è¦ãª **Model / Resolver / Service / Module** ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼š

| Entity         | å†…å®¹                           | é–¢é€£ã‚¹ã‚­ãƒ¼ãƒä¾‹             |
| -------------- | ------------------------------ | -------------------------- |
| `PurchaseInfo` | ã„ã¤ãƒ»ã©ã“ã‹ã‚‰ä»•å…¥ã‚ŒãŸã‹       | `purchaseDate`, `supplier` |
| `Supplier`     | ä»•å…¥å…ˆã®æ¥­è€…æƒ…å ±ï¼ˆåå‰ãƒ»é›»è©±ï¼‰ | `name`, `phone`            |

> ğŸ’¡ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ `purchaseInfos` ã‹ã‚‰ `supplierName + phone` ã‚’ã‚­ãƒ¼ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãª Supplier ã‚’æ§‹ç¯‰ã—ã¾ã—ã‚‡ã†

---

### âœ… å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ä¸€è¦§

1. `purchase-info.model.ts` / `supplier.model.ts` ã‚’å®šç¾©
2. `purchase-info.service.ts` ã‚’ä½œæˆã—ã€StockId ã§ PurchaseInfo ã‚’è¿”ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
3. `supplier.service.ts` ã‚’ä½œæˆã—ã€PurchaseInfo ã‹ã‚‰ Supplier ã‚’è§£æ±ºã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
4. `purchase-info.resolver.ts` ã‚’ä½œæˆã—ã€Field Resolver ã§ `supplier` ã‚’è§£æ±º
5. `stock.resolver.ts` ã« `@ResolveField(() => PurchaseInfo)` ã‚’è¿½åŠ 
6. Playground ã§ä»¥ä¸‹ã®ã‚¯ã‚¨ãƒªãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```graphql
query {
  stocks {
    id
    purchaseInfo {
      purchaseDate
      supplier {
        name
        phone
      }
    }
  }
}
```

---

## âš ï¸ ã‚ˆãã‚ã‚‹ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

### âŒ Field Resolver ã§å€‹åˆ¥ã« HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹

```ts
@ResolveField(() => Client)
client(@Parent() stock: Stock) {
  // ä¸€è¦§ 10 ä»¶ã§ 10 å›å‘¼ã°ã‚Œã‚‹ â†’ N+1 å•é¡Œ
  return this.clientService.fetchClientById(stock.clientId);
}
```

- N+1 å•é¡Œã®å…¸å‹ä¾‹
- ä¸€è¦§è¡¨ç¤ºã§ã¯è‡´å‘½çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹
- æ¬¡ç«  ã§ DataLoader ã«ã‚ˆã‚‹ãƒãƒƒãƒåŒ–ã‚’å­¦ã³ã¾ã™

---

## âœ… æ¬¡ã«é€²ã‚€

æ¬¡ç« ã§ã¯ã€ä»Šå›ç™ºç”Ÿã—ãŸ N+1 å•é¡Œ ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€
DataLoader ã®å°å…¥ã¨ãƒãƒƒãƒå‡¦ç† ã‚’å­¦ã³ã¾ã™ã€‚

ğŸ‘‰ [3. N+1 å•é¡Œã¨ DataLoader ã§ã®è§£æ±ºã¸é€²ã‚€](../03.dataloader-refactor/README.md)
