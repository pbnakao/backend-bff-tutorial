# 3. N+1 å•é¡Œã¨ DataLoader ã§ã®è§£æ±º

GraphQL ã® Field Resolver ã¯ã€ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å‹•çš„ã«è§£æ±ºã§ãã‚‹åé¢ã€**N+1 å•é¡Œï¼ˆä¸è¦ãªç¹°ã‚Šè¿”ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰**ã‚’å¼•ãèµ·ã“ã—ãŒã¡ã§ã™ã€‚

ã“ã®ç« ã§ã¯ã€DataLoader ã‚’æ´»ç”¨ã—ã¦ã“ã®å•é¡Œã‚’è§£æ¶ˆã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨å¯èª­æ€§ã‚’ä¸¡ç«‹ã™ã‚‹å®Ÿè£…æ–¹æ³•ã‚’å­¦ã³ã¾ã™ã€‚

---

## ğŸ¯ æœ¬ç« ã®ã‚´ãƒ¼ãƒ«

- N+1 å•é¡ŒãŒãªãœèµ·ãã‚‹ã‹ã‚’ç†è§£ã™ã‚‹
- DataLoader ã‚’ä½¿ã£ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ã«ãƒãƒƒãƒå‡¦ç†ã™ã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹
- NestJS ã«ãŠã‘ã‚‹æœ¬ç•ªæƒ³å®šã® DataLoader å®Ÿè£…ã‚’ç¿’å¾—ã™ã‚‹
- DataLoader ã¨ `JOIN` ç³»å–å¾—ã¨ã®é•ã„ãƒ»ä½¿ã„åˆ†ã‘ã‚’ç†è§£ã™ã‚‹

---

## ğŸ“˜ N+1 å•é¡Œã¨ã¯ï¼Ÿ

ãŸã¨ãˆã°ã€æ¬¡ã®ã‚ˆã†ãªã‚¯ã‚¨ãƒªã‚’è€ƒãˆã¦ã¿ã¾ã™ï¼š

```graphql
query {
  stocks {
    id
    client {
      id
      name
    }
  }
}
```

ã“ã®æ™‚ã€æ¬¡ã®ã‚ˆã†ãªå‡¦ç†ã«ãªã‚ŠãŒã¡ã§ã™ï¼š

1. `stocks` ã‚’å–å¾—ï¼ˆ1 å›ã®ã‚¯ã‚¨ãƒªï¼‰
2. å„ `stock.client` ã«å¯¾ã—ã¦ã€å€‹åˆ¥ã« client ã‚’å–å¾—ï¼ˆN ä»¶ï¼‰

â†’ åˆè¨ˆ **N+1 å›ã®ãƒ‡ãƒ¼ã‚¿å–å¾—** ãŒç™ºç”Ÿã™ã‚‹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹ï¼‰

---

## ğŸ§ª DataLoader ã«ã‚ˆã‚‹è§£æ±º

ã“ã® N+1 å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãŒ **DataLoader** ã§ã™ã€‚
DataLoader ã‚’ä½¿ã†ã¨ã€**åŒã˜ GraphQL ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§è¤‡æ•°å›å‘¼ã³å‡ºã•ã‚Œã‚‹ ID å–å¾—å‡¦ç†ã‚’ã€è‡ªå‹•çš„ã« 1 å›ã«ã¾ã¨ã‚ã‚‹**ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¾‹ãˆã°ã€Field Resolver å†…ã§ã€ŒClient ã‚’å–å¾—ã—ãŸã„ã€ã¨ã—ã¾ã™ã€‚ã“ã®ã¨ãã€ä»¥ä¸‹ã®ã‚ˆã†ã« DataLoader ã‚’çµŒç”±ã—ã¦å–å¾—ã—ã¾ã™ï¼š

```ts
clientLoader.loader.load(stock.clientId);
```

ã“ã® .load() ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­ã«è¤‡æ•°å›å‘¼ã°ã‚ŒãŸå ´åˆã§ã‚‚ã€DataLoader ã¯å†…éƒ¨çš„ã«æ¬¡ã®ã‚ˆã†ã«å‹•ãã¾ã™ï¼š

```ts
// è‡ªå‹•çš„ã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹ä»•çµ„ã¿ï¼ˆbatchFnï¼‰
const clientLoader = new DataLoader(async (ids: string[]) => {
  // clientService.findByIds(ids) ã¯ WHERE id IN (...) ã«ç›¸å½“
  return this.clientService.findByIds(ids);
});
```

âœ… 10 ä»¶ã® Stock ã«å¯¾ã—ã¦ 10 ä»¶ã® Client ã‚’å–å¾—ã—ã¦ã„ãŸã¨ã—ã¦ã‚‚ã€ â†’ .load() ã®å‘¼ã³å‡ºã—ã¯ 1 å›ã® batchFn() ã§ã¾ã¨ã‚ã¦å‡¦ç†ã•ã‚Œã€åˆè¨ˆ 1+1 å›ã®å–å¾—ã§æ¸ˆã¿ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€

- ã€ŒField Resolver ã§ .load(id) ã‚’æ›¸ãã€
- ã€ŒLoader å´ã§ .findByIds(ids: string[]) ã«ã¾ã¨ã‚ã‚‹ã€
- ã€ŒRepository / DB ã§ã¯ WHERE id IN (...) ã§å–å¾—ã™ã‚‹ã€
  ã¨ã„ã†ä¸‰æ®µæ§‹æˆãŒã€DataLoader ã®åŠ¹æœã‚’ç™ºæ®ã™ã‚‹ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

---

## ğŸ“˜ DataLoader ã®åŸºæœ¬ API è§£èª¬

DataLoader ã¯ã€åŒã˜ GraphQL ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§è¤‡æ•°å›å‘¼ã°ã‚Œã‚‹ `.load(key)` ã‚’è‡ªå‹•ã§ã¾ã¨ã‚ã¦ï¼ˆãƒãƒƒãƒå‡¦ç†ã—ã¦ï¼‰ã€1 å›ã®å–å¾—ã«æœ€é©åŒ–ã§ãã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

```ts
new DataLoader<Key, Value>(batchFn: (keys: readonly Key[]) => Promise<Value[]>)
```

### ğŸ” ä¸»ãªé–¢æ•°ç¾¤ã¨ä½¿ã„æ–¹

| é–¢æ•°å               | æ¦‚è¦                          | å…¸å‹çš„ãªä½¿ã„æ–¹                      | èª¬æ˜                                                                               |
| -------------------- | ----------------------------- | ----------------------------------- | ---------------------------------------------------------------------------------- |
| `.load(key)`         | å˜ä¸€ã®ã‚­ãƒ¼ã«å¯¾ã™ã‚‹å–å¾—ã‚’è¦æ±‚  | `loader.load('c001')`               | è¤‡æ•°å›å‘¼ã°ã‚Œã¦ã‚‚ã€åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§è‡ªå‹•çš„ã«ã¾ã¨ã‚ã¦ `batchFn([...])` ã«æ¸¡ã•ã‚Œã¾ã™ |
| `.loadMany(keys)`    | è¤‡æ•°ã®ã‚­ãƒ¼ã‚’ä¸€æ‹¬ã§å–å¾—        | `loader.loadMany(['c001', 'c002'])` | `.load()` ã‚’è¤‡æ•°å›å‘¼ã¶ã®ã¨åŒã˜ã€‚ãƒãƒƒãƒå‡¦ç†ã•ã‚Œã‚‹                                   |
| `.clear(key)`        | ç‰¹å®šã® key ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ | `loader.clear('c001')`              | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å†å–å¾—ãŒå¿…è¦ãªã¨ãã«ä½¿ç”¨                                               |
| `.clearAll()`        | å…¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤            | `loader.clearAll()`                 | åŒä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã®ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒªã‚»ãƒƒãƒˆ                                     |
| `.prime(key, value)` | æ‰‹å‹•ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’äº‹å‰ç™»éŒ²    | `loader.prime('c001', clientObj)`   | å¤–éƒ¨ã§å–å¾—æ¸ˆã¿ã®å€¤ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«å…¥ã‚Œã‚‹ã¨ãã«ä½¿ã†                                   |

### ğŸ“ æ³¨æ„ç‚¹

- `.load()` ã‚„ `.loadMany()` ã¯éåŒæœŸé–¢æ•°ã§ã™ã€‚å¿…ãš `await` ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `batchFn()` ã®æˆ»ã‚Šå€¤ã¯ã€**keys ã¨åŒã˜é †åº**ã§ãªã‘ã‚Œã°ã„ã‘ã¾ã›ã‚“ã€‚
- æœªè§£æ±ºã®ã‚­ãƒ¼ã«ã¯ `undefined` ã¾ãŸã¯ `null` ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

## âœ… åŸºæœ¬çš„ã«ä½¿ã†ã®ã¯ `.load()` ã¨ `batchFn()` ã®ãƒšã‚¢

ã»ã¨ã‚“ã©ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã€æ¬¡ã® 2 ã¤ã ã‘ã‚’ç†è§£ã—ã¦ã„ã‚Œã°ååˆ†ã§ã™ï¼š

| ä½¿ã†ã‚‚ã®     | ç”¨é€”                                                 |
| ------------ | ---------------------------------------------------- |
| `.load(key)` | ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã« 1 ä»¶ãšã¤å–å¾—è¦æ±‚                    |
| `batchFn()`  | `.load()` ãŒè²¯ã¾ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¸€æ‹¬å–å¾—ï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰ |

ã¤ã¾ã‚Šã€

- `.load()` ã‚’ **Resolver ã‹ã‚‰å‘¼ã³å‡ºã™**
- `batchFn()` ã‚’ **Loader ã‚¯ãƒ©ã‚¹å†…ã§å®šç¾©ã™ã‚‹**

ã“ã®ãƒšã‚¢ã§ DataLoader ã®åŸºæœ¬çš„ãªä»•çµ„ã¿ã¯æˆã‚Šç«‹ã¡ã¾ã™ã€‚

---

## âœ… NestJS ã§ã®å°å…¥æ–¹æ³•ï¼ˆæœ¬ç•ªæƒ³å®šï¼‰

GraphQL ã«ãŠã‘ã‚‹ DataLoader ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¨ã—ã¦ã¯ã€`context.loaders.xxx` ã«æ‰‹å‹•ã§ä»•è¾¼ã‚€æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€ã“ã®æ•™æã§ã¯ **NestJS ã«ã‚ˆã‚‹ã€Œæœ¬ç•ªã§ã‚‚ä½¿ãˆã‚‹æ§‹æˆã€ã‚’å‰æ**ã«å­¦ã‚“ã§ã„ãã¾ã™ã€‚

ãã®æ–¹æ³•ãŒã€NestJS ã® **ä¾å­˜æ€§æ³¨å…¥ï¼ˆDIï¼‰æ©Ÿèƒ½ã‚’æ´»ç”¨ã—ã€`@Injectable({ scope: Scope.REQUEST })` ã‚’ä½¿ã£ã¦ DataLoader ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ã§ç®¡ç†ã™ã‚‹æ–¹æ³•**ã§ã™ã€‚

ã“ã®æ–¹å¼ã‚’æ¡ç”¨ã™ã‚‹ç†ç”±ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ï¼š

- **æœ¬ç•ªç’°å¢ƒã§ã‚‚ãã®ã¾ã¾ä½¿ãˆã‚‹ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªè¨­è¨ˆ**
- ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä¾‹ï¼š`ClientService`ï¼‰ã‚’ Loader ã«æ³¨å…¥ã§ãã‚‹
- NestJS ã® DI ã‚³ãƒ³ãƒ†ãƒŠã§çµ±ä¸€ã•ã‚ŒãŸç®¡ç†ãŒã§ãã‚‹
- ãƒ†ã‚¹ãƒˆãŒã—ã‚„ã™ãã€ä¿å®ˆæ€§ãŒé«˜ã„æ§‹é€ ã«ãªã‚‹

> â€» `@Loader()` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚„ `context.loaders.xxx` ã‚’ä½¿ã†æ–¹æ³•ã¯ã€ç°¡æ˜“çš„ã«ã¯æœ‰åŠ¹ã§ã™ãŒã€æœ¬æ•™æã§ã¯ã‚ãˆã¦ã€Œæœ¬ç•ªæ§‹æˆã«è€ãˆã‚‹å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã«çµã£ã¦è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

---

### Loader ã‚¯ãƒ©ã‚¹ã®æ§‹æˆ

```ts
@Injectable({ scope: Scope.REQUEST })
export class ClientLoader {
  constructor(private readonly clientService: ClientService) {}

  readonly loader = new DataLoader<string, ClientRecord>(async (ids) => {
    return this.clientService.findByIds(ids);
  });
}
```

#### ğŸ” ãªãœ Scope.REQUEST ãŒå¿…è¦ãªã®ã‹ï¼Ÿ

DataLoader ã®ç‰¹æ€§ã¨ã—ã¦ã€ã€Œ**1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ã® .load() å‘¼ã³å‡ºã—ã‚’ãƒãƒƒãƒåŒ–ã™ã‚‹**ã€ã¨ã„ã†ä»•çµ„ã¿ãŒã‚ã‚Šã¾ã™ã€‚
ãã®ãŸã‚ã€**GraphQL ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹**ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã®ã§ã™ã€‚

NestJS ã«ãŠã„ã¦ã¯ã€é€šå¸¸ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚¢ãƒ—ãƒªå…¨ä½“ã§ 1 ã¤ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆï¼ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ï¼‰ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚
ã—ã‹ã— DataLoader ã‚’ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã«ã—ã¦ã—ã¾ã†ã¨ã€**ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã¾ãŸã„ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„ãƒãƒƒãƒãƒ³ã‚°ãŒå…±æœ‰ã•ã‚Œã¦ã—ã¾ã†**ãŸã‚ã€æ„å›³ã—ãªã„å‹•ä½œã«ãªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™ï¼š

```ts
@Injectable({ scope: Scope.REQUEST })
```

ã“ã‚Œã«ã‚ˆã‚Šã€**GraphQL ã®å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã ClientLoader ãŒç”Ÿæˆã•ã‚Œã‚‹**ã‚ˆã†ã«ãªã‚Šã€å®‰å…¨ã‹ã¤æ­£ã—ããƒãƒƒãƒå‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

### Resolver ã§ã®ä½¿ç”¨

```ts
@Resolver(() => Stock)
export class StockResolver {
  constructor(private readonly clientLoader: ClientLoader) {}

  @ResolveField(() => Client)
  client(@Parent() stock: Stock) {
    return this.clientLoader.loader.load(stock.clientId);
  }
}
```

â†’ GraphQL ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã« `ClientLoader` ãŒç”Ÿæˆã•ã‚Œã€`.load()` å‘¼ã³å‡ºã—ãŒãƒãƒƒãƒåŒ–ã•ã‚Œã¾ã™

---

## âš–ï¸ DataLoader vs JOIN ã®ä½¿ã„åˆ†ã‘

| è¦³ç‚¹           | DataLoader                                                                       | JOINï¼ˆLeft Joinï¼‰                                                      |
| -------------- | -------------------------------------------------------------------------------- | ---------------------------------------------------------------------- |
| ä¸»ãªç”¨é€”       | GraphQL ã® Field Resolver ã®æœ€é©åŒ–                                               | SQL / ORM ã«ã‚ˆã‚‹äº‹å‰ã®ä¸€æ‹¬å–å¾—                                         |
| å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚° | å„ Field Resolver ã«å…¥ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å‹•ä½œ                                       | ä¸Šä½ã® Query Resolver ç­‰ã§ã¾ã¨ã‚ã¦å®Ÿè¡Œã•ã‚Œã‚‹                           |
| æŸ”è»Ÿæ€§         | ãƒ•ãƒ­ãƒ³ãƒˆãŒè¦æ±‚ã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘å‡¦ç†ã‚’å®Ÿè¡Œ                                       | çµåˆå…ˆã‚‚å«ã‚ã¦ä¸€æ‹¬å–å¾—ã™ã‚‹ãŸã‚æŸ”è»Ÿæ€§ã«æ¬ ã‘ã‚„ã™ã„                       |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã«å‡¦ç†ãŒåˆ†ã‹ã‚Œã€1+1 æ§‹é€ ã§æŸ”è»Ÿæ€§ãŒé«˜ã„ï¼ˆãƒãƒƒãƒæœ€é©åŒ–ã‚‚å¯èƒ½ï¼‰ | 1 å›ã®ã‚¯ã‚¨ãƒªã§å®Œçµã™ã‚‹ãŸã‚é€Ÿã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ï¼ˆãŸã ã—éå‰°å–å¾—ã®å¯èƒ½æ€§ã‚‚ï¼‰ |

> âœ… çµåˆå…ˆã®æƒ…å ±ã‚’å¸¸ã«å–å¾—ã™ã‚‹æ¥­å‹™è¦ä»¶ã§ã‚ã‚Œã° JOIN ã§ã‚‚ OKã€‚
> ãŸã ã— GraphQL ã®æœ¬è³ªã¯ã€Œå¿…è¦ãªã‚‚ã®ã ã‘ã‚’ã€å¿…è¦ãªã¨ãã«å–ã‚‹ã€ã“ã¨ã€‚
> ãã®æ€æƒ³ã«æ²¿ã†ã®ã¯ DataLoader ã®è¨­è¨ˆã§ã™ã€‚

---

### ğŸ” ãªãœ DataLoader ã®ã»ã†ãŒæŸ”è»Ÿã‹ï¼Ÿ

- **DataLoader** ã¯ã€å„ Field Resolver ã®ä¸­ã§ `.load(id)` ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚
  â†’ ã¤ã¾ã‚Šã€**ãƒ•ãƒ­ãƒ³ãƒˆãŒè¦æ±‚ã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã«å¯¾å¿œã™ã‚‹å‡¦ç†ã ã‘ãŒå®Ÿè¡Œã•ã‚Œã‚‹**ã€‚

- ä¸€æ–¹ã€**JOIN ã‚’ä½¿ã†å ´åˆ**ã¯ã€ä¸Šä½ã® `Query Resolver` ãªã©ã§
  â†’ **ã™ã¹ã¦ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«ã¾ã¨ã‚ã¦å–å¾—ã—ã¦ã—ã¾ã†**ãŸã‚ã€
  â†’ **ãƒ•ãƒ­ãƒ³ãƒˆãŒä½¿ã‚ãªã„æƒ…å ±ã«ã‚‚ç„¡é§„ãªå–å¾—ãƒ»çµåˆãƒ»åŠ å·¥ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ãŒã‚ã‚‹**ã€‚

---

ã“ã®ã‚ˆã†ã«ã€ã€Œ**æŸ”è»Ÿã«è¨­è¨ˆã—ãŸã„ãªã‚‰ DataLoader**ã€ã€ã€Œ**å¸¸ã«ã¾ã¨ã‚ã¦å–ã‚‹ãªã‚‰ JOIN**ã€ã¨ã„ã†ä½¿ã„åˆ†ã‘ãŒé‡è¦ã«ãªã‚Šã¾ã™ã€‚

---

## ğŸ§¾ ãƒ­ã‚°å‡ºåŠ›ã«ã‚ˆã‚‹ãƒãƒƒãƒå‡¦ç†ã®ç¢ºèª

DataLoader ã‚’å°å…¥ã™ã‚‹ã¨ã€è¤‡æ•°ã® `.load()` å‘¼ã³å‡ºã—ãŒ **ã¾ã¨ã‚ã¦ `batchFn()` ã«é›†ç´„ã•ã‚Œã‚‹æ§˜å­**ã‚’ãƒ­ã‚°ã§ç¢ºèªã§ãã¾ã™ã€‚

### âœ… ä»•è¾¼ã¿ä¾‹ï¼ˆ`StockResolver`ï¼‰

```ts
@ResolveField(() => Client)
async client(@Parent() stock: Stock): Promise<ClientRecord> {
    log.verbose(`Requesting Client ${stock.clientId} for Stock ${stock.id}`);
    const client = await this.clientLoader.loader.load(stock.clientId);
    return client;
}
```

### âœ… ä»•è¾¼ã¿ä¾‹ï¼ˆ`ClientLoader`ï¼‰

```ts
readonly loader = new DataLoader<string, ClientRecord>(async (ids) => {
  this.logger.verbose(`ğŸ”„ batchFn called with ids: [${ids.join(', ')}]`);
  const clients = this.clientService.findByIds(ids);
  return ids.map((id) => clients.find((c) => c.id === id));
});
```

### ğŸ–¨ï¸ å®Ÿéš›ã®ãƒ­ã‚°å‡ºåŠ›ï¼ˆä¾‹ï¼‰

ä»¥ä¸‹ã¯ã€GraphQL ã® 1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…ã§ Stock.client ã‚’ 3 ä»¶è§£æ±ºã—ãŸã¨ãã®ãƒ­ã‚°ã§ã™ï¼š

```
[Nest] 15758  - 04/18/2025, 12:06:39 PM VERBOSE [StockResolver] Requesting Client c001 for Stock s001
[Nest] 15758  - 04/18/2025, 12:06:39 PM VERBOSE [StockResolver] Requesting Client c001 for Stock s002
[Nest] 15758  - 04/18/2025, 12:06:39 PM VERBOSE [StockResolver] Requesting Client c002 for Stock s003
[Nest] 15758  - 04/18/2025, 12:06:39 PM VERBOSE [ClientLoader] ğŸ”„ batchFn called with ids: [c001, c002]
[Nest] 15758  - 04/18/2025, 12:06:39 PM VERBOSE [ClientService] ğŸ” findByIds called with ids = [c001, c002]
```

#### ğŸ” èª¬æ˜

- .load() ã¯ 3 å›å‘¼ã°ã‚Œã¦ã„ã‚‹ï¼ˆStock.client ãŒ 3 ä»¶ï¼‰
- ã—ã‹ã—ã€ClientLoader ã® batchFn() ã¯ **1 å›ã—ã‹å‘¼ã°ã‚Œã¦ã„ãªã„**
- ClientService.findByIds() ã«ã‚ˆã‚Šã€**WHERE IN ç›¸å½“ã®å‡¦ç†**ã§ã¾ã¨ã‚ã¦å–å¾—ã•ã‚Œã¦ã„ã‚‹
- çµæœã¨ã—ã¦ã€**N+1 å›ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒ 1+1 ã«å‰Šæ¸›**ã•ã‚Œã¦ã„ã‚‹

## ğŸ”§ å®Ÿè£…æ¼”ç¿’ï¼šDataLoader ã®å°å…¥ï¼ˆphoto / purchaseInfoï¼‰

ã“ã®ç« ã§ã¯ã€ä»¥ä¸‹ã® Field Resolver ã‚’ DataLoader åŒ–ã—ã¦æœ€é©åŒ–ã—ã¦ã„ãã¾ã™ã€‚

| å¯¾è±¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰       | Loader å            | èª¬æ˜                                 |
| -------------------- | -------------------- | ------------------------------------ |
| `Stock.photos`       | `PhotoLoader`        | å†™çœŸï¼ˆè¤‡æ•°ä»¶ï¼‰ã®å–å¾—ã€N+1 ã‚’ãƒãƒƒãƒåŒ– |
| `Stock.purchaseInfo` | `PurchaseInfoLoader` | è³¼å…¥æƒ…å ±ï¼ˆå¿…ãš 1 ä»¶ï¼‰ã®å–å¾—ã‚’æœ€é©åŒ–  |

---

### âœ… å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—

1. `photo.loader.ts` / `purchase-info.loader.ts` ã‚’ä½œæˆã—ã€`@Injectable({ scope: Scope.REQUEST })` ã§å®šç¾©
2. `StockResolver` å´ã§ `.loader.load(stock.id)` ã‚’ä½¿ã£ã¦ãƒãƒƒãƒåŒ–
3. ãƒãƒƒãƒã®æŒ™å‹•ãŒç¢ºèªã§ãã‚‹ã‚ˆã† `console.log()` or `Logger.verbose()` ã‚’è¿½åŠ 
4. ã‚¯ã‚¨ãƒªå®Ÿè¡ŒçµæœãŒæ­£ã—ãè¿”ã‚‹ã‹æ¤œè¨¼

---

## âœ… ã‚¯ã‚¨ãƒªä¾‹

```graphql
query {
  stocks {
    id
    name
    client {
      id
      name
    }
    photos {
      id
      url
    }
    purchaseInfo {
      purchaseDate
      supplier {
        name
        phone
      }
    }
  }
}
```

---

## ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ãƒ­ã‚°ï¼ˆbatch å‡¦ç†ã®å®Ÿè¡Œç¢ºèªï¼‰

```
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [ClientLoader] ğŸ”„ batchFn called with ids: [c001, c002]
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [ClientService] ğŸ” findByIds called with ids = [c001, c002]
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [PhotoLoader] ğŸ”„ batchFn called with stockIds: [s001, s002, s003]
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [PhotoService] ğŸ“¸ findByStockIds called with stockIds = [s001, s002, s003]
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [PurchaseInfoLoader] ğŸ”„ batchFn called with stockIds: [s001, s002, s003]
[Nest] 31391  - 04/18/2025, 2:19:49 PM VERBOSE [PurchaseInfoService] ğŸ“¦ findByStockIds called with stockIds = [s001, s002, s003]
```
